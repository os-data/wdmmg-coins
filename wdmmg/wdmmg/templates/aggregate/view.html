<html xmlns:py="http://genshi.edgewall.org/"
  xmlns:xi="http://www.w3.org/2001/XInclude">

  <py:def function="page_title">Spending</py:def>

  <div py:def="content">
    <form action="${url(controller='aggregate', action='view')}" method="get">
      <p py:if="c.filters">
        Only include spending where:
        <ul>
          <li py:for="key in sorted(c.filters, key=lambda x: x.name)">
            Key '${key.name}' has value '${c.filters[key]}'.
            <input type="submit" name="remove-${key.name}" value="Remove"/>
          </li>
        </ul>
      </p>

      <p>
        <label for="breakdown">Breakdown by</label>
        ${h.select("breakdown", c.axis.name, sorted([key.name for key in c.bd_keys]),
            prompt=u'(no breakdown)')}
        <input type="submit" value="Update"/>
      </p>

      <!-- A utility for formatting amounts of money. -->
      <py:def function="money_td(amount)">
        <!-- TODO: Express in millions -->
        <td class="credit" py:if="amount &gt;= 0">${'%.1f' % (amount/1e6)}</td>
        <td class="debit" py:if="amount &lt; 0">${'(%.1f)' % (amount/1e6)}</td>
      </py:def>

      <table>
        <tr>
          <td py:if="c.axis" scope="col">Â£m</td>
          <th py:for="date in c.results.dates" scope="col">${date}</th>
        </tr>

        <tr py:for="coordinates, data in sorted(c.results.matrix.items())">
          <th py:if="c.axis" scope="row">${coordinates[0]}</th>
          <py:for each="amount in data">${money_td(amount)}</py:for>
        </tr>
        
        <tr py:if="c.axis">
          <th scope="row">Total</th>
          <py:for each="amount in c.totals">${money_td(amount)}</py:for>
        </tr>
      </table>
    </form>
  </div>

  <xi:include href="../layout.html" />
</html>

